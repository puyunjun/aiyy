<?php
// +----------------------------------------------------------------------
// | 海豚PHP框架 [ DolphinPHP ]
// +----------------------------------------------------------------------
// | 版权所有 2016~2017 河源市卓锐科技有限公司 [ http://www.zrthink.com ]
// +----------------------------------------------------------------------
// | 官方网站: http://dolphinphp.com
// +----------------------------------------------------------------------
// | 开源协议 ( http://www.apache.org/licenses/LICENSE-2.0 )
// +----------------------------------------------------------------------

namespace app\index\controller;
use app\user\model\home\User;
use think\cache\driver\Redis;
use app\user\model\home\User As UserModel;
use app\user\model\home\Login;
use think\Session;
use think\Db;

/**
 * 前台首页控制器
 * @package app\index\controller
 */
class Index extends Home
{

    protected function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub

        if(false){
            $this->redirect('user/login/index');
        }
    }

    public function index()
    {
        // 默认跳转模块
        if (config('home_default_module') != 'index') {
            $this->redirect(config('home_default_module'). '/index/index');
        }

        //判断是否登录
        $login_model = new Login();
        $is_login_uid = $login_model->isLogin();
        if(request()->param('invite_code')){
            //是否通过推荐人点击入的
            Session::set('broker_code_uid',request()->param('invite_code'));
        }
        if(session('broker_code_uid') && $is_login_uid){
            //用户再推荐人引导进入网页的时候登录网站 , 记录会员和推荐人关系
            $is_exist = Db::name('broker_user_relation')->where('uid',$is_login_uid)->find();
            if(!$is_exist){
                Db::name('broker_user_relation')
                    ->insert(array('invite_uid'=>session('broker_code_uid'),
                        'uid'=>$is_login_uid,
                        'create_time'=>request()->time()
                    ));
            }
            Session::set('broker_code_uid',null);
        }
        if(intval(request()->param('bindphone')) === 1){
            //提示用户需要绑定手机
            $this->assign('bindphone',intval(1));
        }else{
            $this->assign('bindphone',false);
        }

        /*$config = [
            'host'       => '127.0.0.1',
            'port'       => 6379,
            'password'   => '123456',
            'select'     => 0,
            'timeout'    => 0,
            'expire'     => 0,
            'persistent' => false,
            'prefix'     => '',
        ];

        $Redis=new Redis($config);
        $Redis->set("test","unique");
        echo  $Redis->get("test");*/

        //取出地址
        if(request()->isGet()){

            //上拉刷新请求页面分页数据
            $user = new User();
            $data = $user->escort_info();

            foreach( $data as $k=>$v1 )
            {

                $birthday_format = isset(getIDCardInfo($v1->id_card_num)['birthday']) ? getIDCardInfo($v1->id_card_num)['birthday']:0;
                //若为系统添加伴游,直接通过伴游生日计算
                if($v1->sys_id === 0){
                    $birthday_format =date('Y',$v1->birthday);
                }
                $a = date('Y', time());
                $b = date('Y', strtotime($birthday_format));    //求出年龄
                $data[$k]['id_card_num'] = $birthday_format ? abs($a - $b) : 0;

                $str=$v1["address"];
                $arr_str=explode(" ",$str);//以空格为拆分条件
                $data[$k]['address'] = $arr_str[0];
            }
            $this->assign('data',$data);
        }
        //获取用户当前位置若未登录则不显示距离

        //快捷按钮数据
        //从session里面取出用户id
        $uid = isset(session('user_auth_home')['uid'])?session('user_auth_home')['uid']:'';

        //获取用户信息
        if($uid){
           $quick_user_info = Db::name('__user__')->alias('u')
                                    ->where('u.id',$uid)
                                    ->join('dp_user_identity dui','dui.uid = u.id','LEFT')
                                    ->join('dp_user_group dug','dug.id = u.group_id','LEFT')
                                    ->field('u.nickname,u.head_img,u.sex,u.sys_id,u.phone,u.is_bind_phone,u.is_escort')
                                    ->field('dui.status')
                                    ->field('dug.group_name')
                                    ->find();
           //资料进度
            $progress_num = 0;
           if($quick_user_info['is_bind_phone'] === 1){
               $progress_num ++;
           }
           if($quick_user_info['is_escort'] === 1){
               $progress_num ++;
           }
           if($quick_user_info['group_name'] !== null){
               $progress_num ++;
           }
           if($quick_user_info['status'] === 1){
               $progress_num ++;
           }
           $quick_user_info['progress_num'] = $progress_num;
           $this->assign('quick_user_info',$quick_user_info);
        }else{
            //未登录状态
            $this->assign('quick_user_info',array());
        }
       return $this->fetch();

    }


    public function ossup(){
        return $this->fetch();
    }

    public function ossserver(){
        //require_once VENDOR_PATH.'/sts-server/sts.php';   //已配置好  windows环境可用
        //调用搭建的服务函数获取临时帐号
      $ossup =  new StsServer();
      $ossup->index();
    }

    public function test_up(){
        return $this->fetch();
    }

    public function get_page_data(){
        $page = request()->param('page') ? request()->param('page') :0;
        $user = new User();
        $data = $user->escort_info($page);

        foreach( $data as $k=>$v1 )
        {

            $birthday_format = isset(getIDCardInfo($v1->id_card_num)['birthday']) ? getIDCardInfo($v1->id_card_num)['birthday']:0;
            //若为系统添加伴游,直接通过伴游生日计算
            if($v1->sys_id === 0){
                $birthday_format =date('Y',$v1->birthday);
            }
            $a = date('Y', time());
            $b = date('Y', strtotime($birthday_format));    //求出年龄
            $data[$k]['id_card_num'] = $birthday_format ? abs($a - $b) : 0;

            $str=$v1["address"];
            $arr_str=explode(" ",$str);//以空格为拆分条件
            $data[$k]['address'] = $arr_str[0];
        }
        return json($data);
    }

}
