
{extend name="layout"}
{block name="page_title"}账户明细{/block}
{block name="page_css"}

<link rel="stylesheet" href="__STATIC__/broker/css/index.css" />
<link rel="stylesheet" href="__STATIC__/broker/css/mui.min.css">

<link rel="stylesheet" href="__STATIC__/broker/css/mui.picker.min.css">

<link rel="stylesheet" href="__STATIC__/broker/css/shared.css" />
<style>
    a{color: #303030;}
    .header{position: fixed;top: 0px;left: 0px; z-index: 1;}
    .mui-content{position:fixed;top:126px;bottom:60px;background: #fff;}
</style>
{/block}
<!--头部-->
{block name="page_header"}
<!--头部-->
<header class="header" >
    <div class="nesting">
        <a class="header-btn" onclick="history.go(-1)"><img src="__STATIC__/broker/img/left.png" /></a>
        <div class="align-content">
            <h2 class="align-text" style="color: #FFFFFF;">账户明细</h2>
        </div>
        <a href="#" class="header-btn header-btn1"></a>
    </div>
</header>
{/block}
{block name="content"}
<!--选择年月-->
<section class="billH">
    <span id='result' data-options='{"type":"month"}' class="btn">选择时间:{$year_month}</span>
    <span>支出<i id="money_in"></i>收入<em id="money_out"></em></span>
</section>
<!--下拉刷新容器-->
<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
    <div class="mui-scroll Details">
        <!--数据列表-->
        <ul class="mui-table-view mui-table-view-chevron items">
            <li>
                <label class="fl">分销注册</label>
                <time class="fl cente">3月17日10:39</time>
                <label class="fr cente">+5</label>
            </li>
        </ul>
    </div>
</div>
{/block}
<!--底部-->
{block name="page_js"}
<script src="http://apps.bdimg.com/libs/html5shiv/3.7/html5shiv.min.js"></script>
<script src="__STATIC__/broker/js/mui.min.js"></script>
<script src="__STATIC__/broker/js/mui.picker.min.js"></script>
<script type="text/javascript">
    //上下刷新
    //启用双击监听

    var pagenum=0;
    var year_start = '{$year}';
    var month_start = '{$month}';
    mui.init({
        pullRefresh: {
            container: '#pullrefresh',
            up: {
                height:80,
                auto:true,
                contentrefresh: '正在加载...',
                contentnomore:'暂无更多数据',
                callback: pullupRefresh
            }
        }
    });
    function pullupRefresh() {
        pagenum++;
        setTimeout(function(){
            post(year_start,month_start);
        },100)
    }
    /*
    * @param year string 年月份
    * */
    function post(year,month){
        $('.items').html('');
        $.ajax({
            url:'http://'+window.location.host+'/broker/my_info/sale_record',
            dataType:'JSON',
            data:{year:year,month:month},
            type:'POST',
            success:function(result){
                var res = result.record;
                if(result.money_take.withdrawals){
                    $('#money_in').html('￥'+result.money_take.withdrawals)
                }else {
                    $('#money_in').html('￥'+0.00)
                }
                if(result.money_take.get_money){

                    $('#money_out').html('￥'+result.money_take.get_money)
                }else {
                    $('#money_out').html('￥'+0.00)
                }

                var $html ='';
                for(var i=0;i<res.length;i++){
                    $html += '<li><label class="fl">分销注册</label>'+'<time class="fl cente">'+timestampToTime(res[i].create_time)+'</time>'+'<label class="fr">+'+res[i].get_money+'</label></li>'
                }
                $('.items').append(
                    $html
                )
            }
        });

        mui('#pullrefresh').pullRefresh().endPullupToRefresh(pagenum>1?true:false);
    }
    //选择年月
    (function($) {
        $.init();
        var result = $('#result')[0];
        var btns = $('.btn');
        btns.each(function(i, btn) {
            btn.addEventListener('tap', function() {
                var _self = this;
                if(_self.picker) {
                    _self.picker.show(function (rs) {
                        result.innerText = '选择时间: ' + rs.text;
                        _self.picker.dispose();
                        _self.picker = null;
                    });
                } else {
                    var optionsJson = this.getAttribute('data-options') || '{}';
                    var options = JSON.parse(optionsJson);
                    var id = this.getAttribute('id');
                    _self.picker = new $.DtPicker(options);
                    _self.picker.show(function(rs) {
                        result.innerText = '选择时间: ' + rs.text;
                        year_start = rs.text;
                        post(year_start);
                        _self.picker.dispose();
                        _self.picker = null;
                    });

                }

            }, false);
        });
    })(mui);

    //将时间戳转为日期格式
    function timestampToTime(timestamp) {
        var date = new Date(timestamp * 1000);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
        Y = date.getFullYear() + '-';
        M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
        D = date.getDate() + ' ';
        h = date.getHours() + ':';
        m = date.getMinutes() + ':';
        s = date.getSeconds();
        return Y+M+D;
    }

</script>
{/block}


